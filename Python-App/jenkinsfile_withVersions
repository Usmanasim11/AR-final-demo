pipeline { 
    agent any 

    stages { 
        stage('Cleanup Workspace') {
            steps {
                script {
                    deleteDir()
                }
            }
        }
        
        stage('Checkout') {
            steps {
                script {
                    // Start the SSH agent
                    sshagent(credentials: ['be197210-784a-4432-9160-8041dd5ff8f0']) {
                        // Manually add the host key to known hosts
                        sh 'ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts'
                        // Run your Git commands here
                        sh 'git clone git@bitbucket.org:python9968/python.git'
                    }
                }
            }
        }
        
        stage('Tag Image') {
            steps {
                script {
                    def buildNumber = env.BUILD_NUMBER
                    def imageName = "pythonapp:${buildNumber}"
                    // Build and tag the Docker image with the build number
                    sh "docker build -t ${imageName} -f python/dockerfile ."
                }
            }
        }
        
        stage('Run Container') {
            steps {
                script {
                    def buildNumber = env.BUILD_NUMBER
                    def imageName = "pythonapp:${buildNumber}"
                    def containerName = "python-container-${buildNumber}"
                    // Run the Docker container from the built image
                    sh "docker run --name ${containerName} -d -p 3456:3456 ${imageName} "
                }
            }
        }
        stage('Push to Docker Hub') {
            steps {
                script {
                    def imageName = "pythonapp"
                    def buildNumber = env.BUILD_NUMBER
                    // Log in to Docker Hub
                    docker.withRegistry('https://index.docker.io/v1/', '143ec964-6b24-4dc7-a1ba-508781e9bbc4') {
                        // Push the tagged image to Docker Hub
                    sh "docker tag ${imageName}:${buildNumber} rehmanjaffar/${imageName}:${buildNumber}"
                    sh "docker push rehmanjaffar/${imageName}:${buildNumber}"

                    }
                }
            }
        }
    } 
}
