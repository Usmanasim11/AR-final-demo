pipeline { 
    agent any 

    stages { 
        stage('Cleanup Workspace') {
            steps {
                script {
                    deleteDir()
                }
            }
        }
        
        stage('Checkout') {
            steps {
                script {
                    // Start the SSH agent
                    sshagent(credentials: ['be197210-784a-4432-9160-8041dd5ff8f0']) {
                        // Manually add the host key to known hosts
                        sh 'ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts'
                        // Run your Git commands here
                        sh 'git clone git@bitbucket.org:python9968/python.git'
                    }
                }
            }
        }
        
        stage('Tag Image') {
            steps {
                script {
                    def buildNumber = env.BUILD_NUMBER
                    def imageName = "python-app:${buildNumber}"
                    // Build and tag the Docker image with the build number
                    sh "docker build -t ${imageName} -f python/dockerfile ."
                   docker.withRegistry('https://rehman.docker.com', '34bf19fa-5307-4582-9ccb-e085f6b57957') {
                        // Push the tagged image to your local registry
                        sh "docker tag ${imageName} rehman.docker.com/${imageName}"
                        sh "docker push rehman.docker.com/${imageName}"
                    }
                }
            }
        }
        
        stage('Deploy with Docker Compose') {
            steps {
                script {
                    // Bring down the previous deployment
                    sh "docker-compose -f python/docker-compose.yml down -v"

                    // Update the docker-compose.yml file with the new image tag
                    def buildNumber = env.BUILD_NUMBER
                    sh "sed -i 's/image: python-app:.*/image: python-app:${buildNumber}/' python/docker-compose.yml"

                    // Bring up the latest deployment
                    sh "docker-compose -f python/docker-compose.yml up -d"
                }
            }
        }
    } 
}
